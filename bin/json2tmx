#! /usr/bin/env ruby

require 'any2tmx'
require 'json'

options = Any2Tmx::Options.new('json2tmx')

unless options.valid?
  puts options.errors.first
  exit 1
end

if options.help?
  options.print_help
  exit 0
end

def load(file, locale)
  phrases = JSON.parse(File.read(file))
  traversable = Any2Tmx::Traversable.new(phrases)
  Any2Tmx::PhraseSet.new(traversable, locale)
end

# load source and target phrases
source = load(options.source, options.source_locale)
target = load(options.target, options.target_locale)

# correlate source and target phrases
phrase_count = 0
trans_map = source.zip(target) { phrase_count += 1 }

STDERR.write("Matched #{trans_map.size} of #{phrase_count} source phrases\n")

stream = if options.output
  File.open(options.output, 'w+')
else
  STDOUT
end

Any2Tmx::TmxWriter.write(
  trans_map, source.locale, target.locale, stream
)

if options.output
  STDERR.write("Wrote #{options.output}\n")
end
